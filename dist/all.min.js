!function(e){e.Controller=Stapes.subclass({constructor:function(){e.controller=this,this.view=new View,this.model=new Model,this.bindViewHandlers(),this.bindModelHandlers()},bindViewHandlers:function(){var e=this;this.view.on({"change:viewName":function(i){"landing"===i&&(e.view.emit("renderThumbs"),e.view.bindEvents())},renderThumbs:function(i){var n,t,a=e.view.getAll();i?(n={page:a.page,api:a.api,count:a.pageSize,tag:i},t=e.model.getImagesByTags(n)):(n={page:a.page,api:a.api,count:a.pageSize},t=e.model.getLandingPageViewData(n)),e.view.set("newtwork",!0),$.when(t).done(function(n){n&&"ok"===n.stat&&(e.view.set("page",n.photos.page+1),n.photos.isTagSearch=!!i,e.view.render.call(e.view,n.photos))})}})},bindModelHandlers:function(){this.model.on({})}})}(window);
var Model=new Stapes.subclass({constructor:function(){},getLandingPageViewData:function(a){var e="https://api.flickr.com/services/rest/?method=flickr.photos.getRecent&api_key="+a.api+"&per_page="+a.count+"&page="+a.page+"&format=json&nojsoncallback=1&extras=tags";return $.ajax({url:e,type:"GET"})},getImagesByTags:function(a){var e="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+a.api+"&tags="+a.tag+"&format=json&nojsoncallback=1&extras=tags&per_page="+a.count+"&page="+a.page;return $.ajax({url:e,type:"GET"})}});
window.renderTpl=function(n,a,e,i){var t=window.templates[n]||window.partials[n],w=i?$(i):$("#images");t&&w&&(e?w.append(t(a)):w.html("").html(t(a)))};
function initRoutes(){var e={landing:function(e,n){var i=window.controller.view.get("viewName");"landing"===i?window.controller.view.set("viewName","home"):window.controller.view.set("viewName","landing")}};page("/",e.landing),page()}
var View=new Stapes.subclass({constructor:function(){this.setupViewData(),this.setupHandlebars()},setupViewData:function(){this.set({viewName:void 0,api:"8646a19eac46052be355f18b48678972",pageSize:30,page:1,images:[],newtwork:!1,tags:{},filter:null})},setupHandlebars:function(){Handlebars.registerHelper("makeTags",function(t,e){var r,i=window.controller.view.get("tags");if(t.length>0){r=t.replace(/[^A-Z0-9\s]/gi,"").split(" ");for(var n=0,a=r.length;a>n;n++)r[n].length>14&&(r[n]=r[n].slice(0,14)),i[r[n]]?i[r[n]]<36&&(i[r[n]]+=1):i[r[n]]=1;return window.controller.view.set("tags",i),r.join(" ")}return r}),Handlebars.registerHelper("math",function(t,e,r,i){return t=parseFloat(t),r=parseFloat(r),{"+":t+r,"-":t-r,"*":t*r,"/":t/r,"%":t%r}[e]}),Handlebars.registerHelper("gt",function(t,e,r){return t>e?r.fn(this):r.inverse(this)})},render:function(t){var e=t.page>1;renderTpl("thumbnail",{photos:t.photo},e),this.set("newtwork",!1),this.loadImg(),this.updateTags(),t.isTagSearch||this.handleThumbs(this.get("filter"))},bindEvents:function(){var t=this;$(".tags").on("click","span",function(e){t.set("tags",{}),t.set("page",1),t.handleThumbs($(this).html())}),$(window).scroll(function(){!t.get("newtwork")&&t.get("page")<68&&$(window).scrollTop()+$(window).height()>$(".tags").outerHeight()+$(".images").outerHeight()-450&&t.emit("renderThumbs",t.get("filter"))})},loadImg:function(){[].forEach.call(document.querySelectorAll("img[data-src]"),function(t){t.setAttribute("src",t.getAttribute("data-src")),t.onload=function(){t.removeAttribute("data-src")}})},updateTags:function(){renderTpl("tags",{tags:window.controller.view.get("tags")},!1,$(".tags"))},handleThumbs:function(t){var e=this;if(t){var r=$(".thumb");r.hide(),r.filter("."+t).show(),e.set("filter",t),e.emit("renderThumbs",t)}}});